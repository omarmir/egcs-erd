<html>
  <head>
    <title>Layout Migrator</title>
  </head>
  <body>
    <div id="app">
      <h2>ChartDB Layout Migrator</h2>
      <p>
        Upload the source JSON (with the good layout) and the target JSON (that
        needs the layout).
      </p>

      <div class="upload-section">
        <label>1. Source JSON (Layout Source):</label>
        <input type="file" id="sourceFile" accept=".json" />
      </div>

      <div class="upload-section">
        <label>2. Target JSON (To be updated):</label>
        <input type="file" id="targetFile" accept=".json" />
      </div>

      <button id="processBtn">Apply Layout & Download</button>
      <button id="dbmlBtn">Download Target as DBML</button>

      <div id="status"></div>
    </div>
  </body>

  <script type="text/javascript">
    const normalize = (value) =>
      String(value || "")
        .trim()
        .toLowerCase()

    // ==============================
    // Convert ChartDB JSON → DBML
    // ==============================
    function convertJsonToDbml(json) {
      if (!json || !Array.isArray(json.tables)) {
        throw new Error("Invalid ChartDB JSON structure.");
      }
    
      const lines = [];
    
      json.tables.forEach((table) => {
        if (!Array.isArray(table.fields)) return;
    
        lines.push(`Table "${table.name}" {`);
    
        // Collect primary key field IDs from indexes (safer)
        const primaryKeyFieldIds = new Set();
    
        if (Array.isArray(table.indexes)) {
          table.indexes.forEach((idx) => {
            if (idx.isPrimaryKey && Array.isArray(idx.fieldIds)) {
              idx.fieldIds.forEach((id) => primaryKeyFieldIds.add(id));
            }
          });
        }
    
        table.fields.forEach((field) => {
          const fieldName = field.name;
          const fieldType = field.type?.name || "varchar";
    
          const attributes = [];
    
          // Primary Key
          if (field.primaryKey || primaryKeyFieldIds.has(field.id)) {
            attributes.push("pk");
          }
    
          // Unique
          if (field.unique) {
            attributes.push("unique");
          }
    
          // Not Null
          if (field.nullable === false) {
            attributes.push("not null");
          }
    
          // Auto increment (if ever used)
          if (field.increment) {
            attributes.push("increment");
          }
    
          const attrString =
            attributes.length > 0 ? ` [${attributes.join(", ")}]` : "";
    
          lines.push(`  ${fieldName} ${fieldType}${attrString}`);
        });
    
        lines.push("}");
        lines.push(""); // spacing between tables
      });
    
      return lines.join("\n");
    }

    // ==========================================
    // APPLY LAYOUT BUTTON
    // ==========================================
    document
      .getElementById("processBtn")
      .addEventListener("click", async () => {
        const sourceFile = document.getElementById("sourceFile").files[0]
        const targetFile = document.getElementById("targetFile").files[0]
        const status = document.getElementById("status")

        if (!sourceFile || !targetFile) {
          status.innerText = "Please upload both files first."
          return
        }

        try {
          const sourceData = JSON.parse(await sourceFile.text())
          const targetData = JSON.parse(await targetFile.text())

          const tablePositionMap = new Map()

          if (Array.isArray(sourceData.tables)) {
            sourceData.tables.forEach((table) => {
              const key = normalize(table.name)
              tablePositionMap.set(key, {
                x: table.x,
                y: table.y,
                width: table.width,
                height: table.height,
              })
            })
          }

          let updatedTables = 0

          if (Array.isArray(targetData.tables)) {
            targetData.tables.forEach((table) => {
              const savedPosition = tablePositionMap.get(
                normalize(table.name)
              )

              if (savedPosition) {
                table.x = savedPosition.x
                table.y = savedPosition.y
                table.width = savedPosition.width
                table.height = savedPosition.height
                updatedTables++
              }
            })
          }

          const updatedJson = JSON.stringify(targetData, null, 2)
          const blob = new Blob([updatedJson], {
            type: "application/json",
          })
          const url = URL.createObjectURL(blob)

          const downloadLink = document.createElement("a")
          downloadLink.href = url
          downloadLink.download = `layout_applied_${targetFile.name}`
          document.body.appendChild(downloadLink)
          downloadLink.click()
          document.body.removeChild(downloadLink)
          URL.revokeObjectURL(url)

          status.innerText = `✅ Updated ${updatedTables} tables.`
        } catch (err) {
          status.innerText = "Error processing JSON: " + err.message
        }
      })

    // ==========================================
    // DOWNLOAD DBML BUTTON
    // ==========================================
    document
      .getElementById("dbmlBtn")
      .addEventListener("click", async () => {
        const targetFile = document.getElementById("targetFile").files[0]
        const status = document.getElementById("status")

        if (!targetFile) {
          status.innerText = "Please upload the target JSON first."
          return
        }

        try {
          const targetData = JSON.parse(await targetFile.text())
          const dbml = convertToDBML(targetData)

          const blob = new Blob([dbml], { type: "text/plain" })
          const url = URL.createObjectURL(blob)

          const downloadLink = document.createElement("a")
          downloadLink.href = url
          downloadLink.download = targetFile.name.replace(".json", ".dbml")
          document.body.appendChild(downloadLink)
          downloadLink.click()
          document.body.removeChild(downloadLink)
          URL.revokeObjectURL(url)

          status.innerText = "✅ DBML file generated."
        } catch (err) {
          status.innerText = "Error generating DBML: " + err.message
        }
      })
  </script>
</html>
